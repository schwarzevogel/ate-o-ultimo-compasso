<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Até o Último Compasso</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
  <style>
    body { margin: 0; background: #000; font-family: Arial, Helvetica, sans-serif; }
    canvas { display: block; margin: 0 auto; }
  </style>
</head>
<body>
<script>
/************************************************************
 * JOGO: Até o Último Compasso
 * ETAPA 1: Ritmo da Valsa (3/4)
 ************************************************************/

class Primavera extends Phaser.Scene {
  constructor() {
    super('Primavera');
  }

  preload() {
    this.load.audio('valsa', 'assets/rosen.mp3');
  }

  create() {
    this.add.text(20, 20, 'Até o Último Compasso', { fontSize: '22px', fill: '#ffffff' });
    this.add.text(20, 50, 'Primavera – Parque', { fontSize: '16px', fill: '#cce6cc' });

    this.instruction = this.add.text(20, 90, 'Toque para iniciar a dança', { fontSize: '16px', fill: '#ffffff' });

    // Player
    this.player = this.add.circle(120, 320, 20, 0xffc0cb);

    // Música
    this.music = this.sound.add('valsa', { volume: 0.6 });

    // ===== RITMO DA VALSA =====
    this.bpm = 170; // valor aproximado da valsa
    this.beatInterval = 60000 / this.bpm;
    this.currentBeat = 0; // 0,1,2 (3 tempos)
    this.lastBeatTime = 0;
    this.hitWindow = 180; // ms aceitáveis para acerto

    // Indicador visual do compasso
    this.beatIndicator = this.add.circle(400, 500, 15, 0xffffff);

    this.started = false;
    this.speed = 40;

    this.input.once('pointerdown', () => {
      this.started = true;
      this.music.play();
      this.instruction.setText('Siga o ritmo da valsa');
      this.lastBeatTime = this.time.now;
    });

    this.input.on('pointerdown', () => {
      if (!this.started) return;
      this.checkHit();
    });
  }

  update(time, delta) {
    if (!this.started) return;

    // Avança o ritmo
    if (time - this.lastBeatTime >= this.beatInterval) {
      this.currentBeat = (this.currentBeat + 1) % 3;
      this.lastBeatTime += this.beatInterval;
      this.pulse();
    }

    // Movimento contínuo
    this.player.x += this.speed * delta / 1000;

    if (this.player.x > 760) {
      this.music.stop();
      this.scene.start('Final');
    }
  }

  pulse() {
    const colors = [0xffdddd, 0xddffdd, 0xddddff];
    this.beatIndicator.setFillStyle(colors[this.currentBeat]);
    this.tweens.add({
      targets: this.beatIndicator,
      scale: { from: 1.5, to: 1 },
      duration: 200
    });
  }

  checkHit() {
    const now = this.time.now;
    const diff = Math.abs(now - this.lastBeatTime);

    if (diff <= this.hitWindow) {
      // ACERTO
      this.player.x += 35;
    } else {
      // ERRO
      this.music.stop();
      this.scene.restart();
    }
  }
}

class Final extends Phaser.Scene {
  constructor() { super('Final'); }

  create() {
    this.cameras.main.setBackgroundColor('#0b1a2b');

    this.add.text(400, 260, 'Até o Último Compasso', { fontSize: '28px', fill: '#ffffff' }).setOrigin(0.5);
    this.add.text(400, 320, 'Te amo!', { fontSize: '48px', fill: '#ffb6c1' }).setOrigin(0.5);
  }
}

const config = {
  type: Phaser.AUTO,
  width: 800,
  height: 600,
  backgroundColor: '#1a2b1a',
  scene: [Primavera, Final],
  audio: { disableWebAudio: false }
};

new Phaser.Game(config);
</script>
</body>
</html>
